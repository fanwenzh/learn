<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>zepto轮播</title>
    <link rel="stylesheet" href="../lib/css/normalize.fwz.css">
    <style type="text/css">
        .banner {
            height: 3rem;
            overflow: hidden;
            position: relative;
        }
        
        .banner .wrapper {
            height: 100%;
            position: absolute;
            top: 0;
            /*  100%屏幕 */
            left: -100%;
        }
        
        .banner .wrapper .slide {
            height: 100%;
            float: left;
            background-color: #999;
        }
        
        .banner .wrapper .slide .img {
            width: 100%;
            height: 100%;
        }
        
        .tip {
            text-align: center;
            position: absolute;
            bottom: .1rem;
            width: 100%;
            height: .16rem;
            /* ul下的li有浏览器默认距离  */
            font-size: 0;
        }
        
        .tip li {
            display: inline-block;
            margin: 0 0.05rem;
            width: .16rem;
            height: .16rem;
            border-radius: 50%;
            background: lightseagreen;
        }
        
        .tip li.bg {
            background: blue;
        }
    </style>
</head>

<body>
    <section class="banner">
        <div class="wrapper">
            <div class="slide">
                <div class="img" style="background-color:lightgray" data-src="1.jpg"></div>
            </div>
            <div class="slide">
                <div class="img" style="background-color:lightblue" data-src="2.jpg"></div>
            </div>
            <div class="slide">
                <div class="img" style="background-color:yellow" data-src="3.jpg"></div>
            </div>
            <div class="slide">
                <div class="img" style="background-color:lightgreen" data-src="4.jpg"></div>
            </div>
            <div class="slide">
                <div class="img" style="background-color:lightgray" data-src="1.jpg"></div>
            </div>
            <div class="slide">
                <div class="img" style="background-color:lightblue" data-src="2.jpg"></div>
            </div>
        </div>
        <ul class="tip">
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
        </ul>
    </section>
    <script charset="utf-8" type="text/javascript" src="../lib/movement/zepto/zepto-1.2.0.min.js"></script>
    <script type="text/javascript">
        // REM布局
        ~ function() {
            document.documentElement.style.fontSize = document.documentElement.clientWidth / 640 * 100 + "px";
        }();
        // 阻止touch move原生事件,同touch.js
        $(document).on('touchmove touchstart touchend', function(e) {
            e.preventDefault();
        });

        // banner render
        var bannerRender = (function() {
            var winW = document.documentElement.clientWidth,
                maxL = 0,
                minL = 0;
            var $banner = $('.banner'),
                $wrapper = $banner.children(".wrapper"),
                $slideList = $wrapper.children(".slide"),
                $imgList = $wrapper.find('.img');
            var step = 1,
                count = $slideList.length,
                followTimer = null;

            //pubilc FN
            function isSwipe(strX, strY, endX, endY) {
                return Math.abs(endX - strX) > 0 || Math.abs(endY - strX) > 0;
            }

            function swipeDir(strX, strY, endX, endY) {
                return Math.abs(endX - strX) >= Math.abs(endY - endY) ?
                    (endX - strX > 0 ? 'right' : 'left') : (endY - strY > 0 ? 'down' : 'up');
            }

            // touch start
            function dragStart(e) {
                var point = e.touches[0];
                $wrapper.attr({
                    // jq 获得的属性值带有单位
                    strL: parseFloat($wrapper.css('left')),
                    strX: point.clientX,
                    strY: point.clientY,
                    isMove: false,
                    dir: null,
                    changeX: null
                })
                $wrapper[0].style.transitionDuration = '0s';
            }
            // touch move
            function dragIng(e) {
                var point = e.touches[0];
                var endX = point.clientX,
                    endY = point.clientY,
                    strX = parseFloat($wrapper.attr('strX')),
                    strY = parseFloat($wrapper.attr('strY')),
                    strL = parseFloat($wrapper.attr('strL')),
                    changeX = endX - strX;
                // 计算是否滑动以及滑动的方向
                var isMove = isSwipe(strX, strY, endX, endY),
                    dir = swipeDir(strX, strY, endX, endY);
                if (isMove && /(left|right)/i.test(dir)) {
                    var curL = strL + changeX;
                    curL = curL > maxL ? maxL : (curL < minL ? minL : curL);
                    $wrapper.attr({
                        dir: dir,
                        isMove: true,
                        changeX: changeX
                    });
                    $wrapper.css('left', curL);
                }
            }
            // touch end
            function dragEnd(e) {
                var dir = $wrapper.attr('dir'),
                    isMove = $wrapper.attr('isMove'),
                    changeX = parseFloat($wrapper.attr('changeX'));

                if (Math.abs(changeX) > winW / 2) {
                    changeX > 0 ? step-- : step++;
                    if (step <= 0) {
                        step = count - 2;
                        $wrapper[0].style.webkitTransitionDuration = '0s';
                    } else if (step >= count - 1) {
                        step = 1;
                        $wrapper[0].style.webkitTransitionDuration = '0s';
                    } else {
                        $wrapper[0].style.webkitTransitionDuration = '0.2s';
                    }
                    lazyImg();
                }
                // 或者用定时器实现跳转
                // window.clearTimeout(followTimer);
                // followTimer = window.setTimeout(function() {
                //     if (step === 0 || step === count - 1) {
                //         $wrapper[0].style.webkitTransitionDuration = '0s';
                //         step = step === 0 ? count - 2 : 1;
                //         $wrapper.clearTimeout(followTimer);
                //         lazyImg(); 
                //     }
                //     window.clearTimeout(followTimer);
                // }, 200);
                $wrapper.css('left', -step * winW);
            }
            // step及相邻活动块延迟加载
            function lazyImg() {
                var $cur = $slideList.eq(step),
                    $tar = $cur.add($cur.prev()).add($cur.next());
                $tar.each(function(index, item) {
                    var $img = $(item).children('.img');
                    // attr存储和获取的属性都为字符串类型
                    if ($img.attr('isLoad') === 'true') {
                        return;
                    }
                    var oImg = new Image;
                    oImg.src = $img.attr('data-src');
                    oImg.onload = function() {
                        $img.attr({
                            // this:oImg 对象~
                            src: this.src,
                            isLoad: true
                        }).css('display', 'block');
                        oImg = null;
                    }
                })
            }
            // swipe left or swipe right

            return {
                init: function() {
                    // init css style
                    minL = -($slideList.length - 1) * winW;
                    $slideList.css("width", winW);
                    $wrapper.css("width", $slideList.length * winW);
                    // lazyImg();
                    // swipe left or right
                    $banner.on('touchstart', dragStart).on('touchmove', dragIng).on('touchend', dragEnd);
                }
            }
        })();
        bannerRender.init();
    </script>
</body>

</html>