<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./css/tab.css">
    <title>表格排序</title>
    <style>

    </style>
</head>

<body>
    <div class="box">
        <table id="tab" cellspacing="0" cellpadding="0">
            <!--只能有一个thead-->
            <thead>
                <tr>
                    <th class="cursor">姓名</th>
                    <th class="cursor">年龄</th>
                    <th class="cursor">武力</th>
                    <th>性别</th>
                </tr>
            </thead>
            <!--可以有多个tbody-->
            <tbody>
                <tr>
                    <td>为胸衣</td>
                    <td>1</td>
                    <td>132</td>
                    <td>男</td>
                </tr>
                <tr>
                    <td>符号</td>
                    <td>12</td>
                    <td>111</td>
                    <td>男</td>
                </tr>
                <tr>
                    <td>奖励</td>
                    <td>13</td>
                    <td>130</td>
                    <td>男</td>
                </tr>
                <tr>
                    <td>令狐冲</td>
                    <td>14</td>
                    <td>102</td>
                    <td>男</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!--需要根据js之间的依赖关系引入js: require.js-->
    <script type="text/javascript" charset="utf-8" src="./utils.js"></script>
    <script>
        // 30 表格排序
        //table // cellspacing, cellpadding = "0"
        // thead tbody tr th
        var table = document.getElementById("tab");
        // 表格特有属性：第一行rows[0], 所有列cells
        var oThs = table.tHead.rows[0].cells;
        // 获取tBody
        var tBody = table.tBodies[0];
        // 获取第一行所有列
        var oRows = tBody.rows;

        var data = null;
        // 1.Ajax: async javascript and xml
        // 创建请求
        var xhr = new XMLHttpRequest;
        // // 打开请求数据的地址, 可以是(text格式, 文本保存为text格式)
        xhr.open("get", "./data.text", false)
            // 监听请求的状态
        xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && /^2\d{2}$/.test(xhr.status)) {
                    var val = xhr.responseText;
                    console.log(val);
                    data = utils.jsonParse(val); // 记住
                }
            }
            // 发送请求
        xhr.send();
        // 2.实现数据绑定
        function bind() {
            var frg = document.createDocumentFragment;
            for (var i = 0; i < data.length; i++) {
                var cur = data[i];
                var oTr = document.createElement("tr");
                for (var key in cur) { // cur为键值对储存形式
                    var oTd = document.createElement("td");
                    if (key === "sex") {
                        oTd.innnerHTMl = cur[key] === 0 ? "男" : "女";
                    } else {
                        oTd.innerHTML = cur[key];
                    }
                    oTr.appendChild(oTd);
                }
                frg.appendChild(oTr);
            }
            tBody.appendChild(frg);
            frg = null;
        }
        // 3.隔行变色
        function changeBg() {
            for (var i = 0; i < oRows.length; i++) {
                oRows[i].className = i % 2 === 1 ? "bg" : null;
            }
        }
        // 原生js实现增减class 
        function hasClass(obj, cls) {
            // new RegExp创建必须添加反斜线\实现转义
            return obj.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
        }

        function addClass(obj, cls) {
            if (!this.hasClass(obj, cls)) obj.className += " " + cls;
        }

        function removeClass(obj, cls) {
            if (hasClass(obj, cls)) {
                var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
                obj.className = obj.className.replace(reg, ' ');
            }
        }

        function toggleClass(obj, cls) {
            if (hasClass(obj, cls)) {
                removeClass(obj, cls);
            } else {
                addClass(obj, cls);
            }
        }
        // 4.按表格排序方法进行排序
        function sort(index) {
            let ary = utils.listToArray(oRows);
            // 36点击当前列时让其他列初始化flag: -1
            for (let k = 0; k < oThs.length; k++) {
                if (oThs[k] !== this) {
                    oThs[k].flag = -1;
                }
            }
            // 改变flag
            this.flag *= -1;
            let _this = this;
            ary.sort(function(a, b) {
                const curInn = a.cells[index].innerHTML,
                    nextInn = b.cells[index].innerHTML;
                const curInnNum = parseFloat(curInn),
                    nextInnNum = parseFloat(nextInn);
                if (isNaN(curInnNum) || isNaN(nextInnNum)) {
                    return curInn.localeCompare(nextInn);
                }
                return (curInnNum - nextInnNum) * _this.flag;
            })
            let frg = document.createDocumentFragment();
            for (let i = 0; i < ary.length; i++) {
                frg.appendChild(ary[i]);
            }
            tBody.appendChild(frg);
            frg = null;
            changeBg()
        }
        // 5.通过在元素内增加自定义属性标识排序，通过* -1实现升降序排列
        // oThs[1].flag = -1;
        // oThs[1].onclick = function() {
        //         sort(1);
        //     }
        // 34 this优化
        // oThs[1].onclick = function() {
        //         let index = 1;
        //         sort.call(this, index);
        //     }
        // 35 所有.cursor的列可以点击
        // querySelect
        for (let i = 0; i < oThs.length; i++) {
            var curTh = oThs[i];
            // 增添属性！
            curTh.index = i; // 存储列的index
            curTh.flag = -1; // 存储索引
            if (curTh.className === "cursor") {
                curTh.onclick = function() {
                    // this -> curTh
                    sort.call(this, this.index);
                }
            }
        }
    </script>
</body>

</html>